---
- name: Ensure download directory exists
  ansible.builtin.file:
    path: "{{ kasmvnc_download_dir | default(ansible_facts['env']['HOME'] ~ '/.cache/kasmvnc') }}"
    state: directory
    mode: "0755"

- name: Fetch latest KasmVNC deb URL for bookworm amd64
  ansible.builtin.shell: |
    set -o pipefail
    curl -s https://api.github.com/repos/kasmtech/KasmVNC/releases/latest \
      | grep "browser_download_url.*deb" \
      | grep bookworm \
      | grep amd \
      | cut -d : -f 2,3 \
      | tr -d '"'
  args:
    executable: /bin/bash
  register: kasmvnc_deb_url
  changed_when: false

- name: Download KasmVNC deb
  ansible.builtin.get_url:
    url: "{{ kasmvnc_deb_url.stdout | trim }}"
    dest: "{{ kasmvnc_download_dir | default(ansible_facts['env']['HOME'] ~ '/.cache/kasmvnc') }}/kasmvnc.deb"
    mode: "0644"
  when: kasmvnc_deb_url.stdout | length > 0

- name: Install KasmVNC deb
  ansible.builtin.apt:
    deb: "{{ kasmvnc_download_dir | default(ansible_facts['env']['HOME'] ~ '/.cache/kasmvnc') }}/kasmvnc.deb"
    state: present
  when: kasmvnc_deb_url.stdout | length > 0
  become: true

- name: Ensure ansible user is in ssl-cert group
  ansible.builtin.user:
    name: "{{ ansible_facts['user_id'] }}"
    groups: ssl-cert
    append: true
  become: true

- name: Ensure ~/.vnc directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.vnc"
    state: directory
    mode: "0755"

- name: Copy kasm.sh to home directory
  ansible.builtin.copy:
    src: kasm.sh
    dest: "{{ ansible_facts['env']['HOME'] }}/kasm.sh"
    mode: "0755"

- name: Copy xstartup to ~/.vnc
  ansible.builtin.copy:
    src: xstartup
    dest: "{{ ansible_facts['env']['HOME'] }}/.vnc/xstartup"
    mode: "0755"

- name: Set KasmVNC password for user
  shell:
    echo "password\npassword\n" | kasmvncpasswd -u {{ ansible_facts['user_id'] }} -owr
  become: true
  become_user: "{{ ansible_facts['user_id'] }}"
  register: kasmvncpasswd_result
  changed_when: kasmvncpasswd_result.rc == 0

- name: Set Kasm User permissions
  shell:
    kasmvncpasswd -u {{ ansible_facts['user_id'] }} -ownr
  become: true
  become_user: "{{ ansible_facts['user_id'] }}"
